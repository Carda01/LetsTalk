from airflow import DAG
from airflow.providers.docker.operators.docker import DockerOperator
from datetime import datetime
from docker.types import Mount
from airflow.models import Variable
from airflow.hooks.base import BaseHook
import os

is_gcs_enabled = Variable.get("is_gcs_enabled", "False")
base_path = "/Users/alfio/projects/upc/BDMP2/"
dags = os.path.join(base_path, 'dags')
data = os.path.join(base_path, 'data')
conn = BaseHook.get_connection('pinecone')
pinecone_key = conn.password

with DAG(
    dag_id="news_pinecone",
    start_date=datetime(2025, 5, 1),
    description='A dag that moves data from the landing to the trusted zone applying some processing for the sports data',
    schedule_interval="@daily",
    catchup=False
) as dag:

    news_to_pinecone = DockerOperator(
        task_id="news_to_pinecone",
        image="bdma_spark:1.0",
        command="/script/news_exploitation_script.py",
        environment={"IS_GCS_ENABLED": is_gcs_enabled, "PINECONE_KEY": pinecone_key},
        mounts=[Mount(source=dags, target='/script/', type='bind'), Mount(source=data, target='/data/', type='bind')],
        docker_url="unix://var/run/docker.sock",
        network_mode="bridge",
        auto_remove='success',
        mount_tmp_dir=False,
    )

    news_to_pinecone
